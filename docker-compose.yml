services:

  # ============================================================
  # TRAEFIK - Reverse proxy + SSL automatique (Let's Encrypt)
  # ============================================================
  traefik:
    image: traefik:v3.2
    container_name: activeducation-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro   # Decouverte des services Docker
      - ./traefik/traefik.yml:/traefik.yml:ro          # Config statique
      - ./traefik/letsencrypt:/letsencrypt             # Stockage certificats SSL
    networks:
      - app-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # BACKEND - API FastAPI
  # Accessible via : https://api.activeduhub.com
  # ============================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: activeducation-api
    restart: unless-stopped
    env_file:
      - ./backend/.env.production
    expose:
      - "8000"
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      # Routing
      - "traefik.http.routers.backend.rule=Host(`api.activeduhub.com`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"
      # Security headers
      - "traefik.http.middlewares.api-headers.headers.stsSeconds=63072000"
      - "traefik.http.middlewares.api-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.api-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.api-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.api-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.api-headers.headers.customResponseHeaders.X-Frame-Options=DENY"
      - "traefik.http.routers.backend.middlewares=api-headers"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ============================================================
  # APP-FRONTEND - Application Etudiante (Flutter Web statique)
  # Accessible via : https://activeduhub.com
  # https://www.activeduhub.com -> redirect vers activeduhub.com
  # ============================================================
  app-frontend:
    image: nginx:1.25-alpine
    container_name: activeducation-app
    restart: unless-stopped
    volumes:
      - ./nginx/app.conf:/etc/nginx/conf.d/default.conf:ro
      - ./activ_education_app/build/web:/var/www/html:ro
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      # Router principal : activeduhub.com
      - "traefik.http.routers.app.rule=Host(`activeduhub.com`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
      - "traefik.http.services.app.loadbalancer.server.port=80"
      # Security headers app
      - "traefik.http.middlewares.app-headers.headers.stsSeconds=63072000"
      - "traefik.http.middlewares.app-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.app-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.app-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.app-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.app-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.app-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.app-headers.headers.customResponseHeaders.X-Frame-Options=SAMEORIGIN"
      - "traefik.http.routers.app.middlewares=app-headers"
      # Router www -> redirect permanent vers non-www
      - "traefik.http.routers.app-www.rule=Host(`www.activeduhub.com`)"
      - "traefik.http.routers.app-www.entrypoints=websecure"
      - "traefik.http.routers.app-www.tls.certresolver=letsencrypt"
      - "traefik.http.routers.app-www.service=app"
      - "traefik.http.middlewares.www-redirect.redirectregex.regex=^https://www\\.activeduhub\\.com(.*)"
      - "traefik.http.middlewares.www-redirect.redirectregex.replacement=https://activeduhub.com$${1}"
      - "traefik.http.middlewares.www-redirect.redirectregex.permanent=true"
      - "traefik.http.routers.app-www.middlewares=www-redirect"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # ============================================================
  # ADMIN-FRONTEND - Dashboard Administrateur (Flutter Web statique)
  # Accessible via : https://admin.activeduhub.com
  # ============================================================
  admin-frontend:
    image: nginx:1.25-alpine
    container_name: activeducation-admin
    restart: unless-stopped
    volumes:
      - ./nginx/admin.conf:/etc/nginx/conf.d/default.conf:ro
      - ./admin_dashboard/build/web:/var/www/html:ro
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      # Routing
      - "traefik.http.routers.admin.rule=Host(`admin.activeduhub.com`)"
      - "traefik.http.routers.admin.entrypoints=websecure"
      - "traefik.http.routers.admin.tls.certresolver=letsencrypt"
      - "traefik.http.services.admin.loadbalancer.server.port=80"
      # Security headers admin (plus restrictif - interface sensible)
      - "traefik.http.middlewares.admin-headers.headers.stsSeconds=63072000"
      - "traefik.http.middlewares.admin-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.admin-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.admin-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.admin-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.admin-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.admin-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.admin-headers.headers.customResponseHeaders.X-Frame-Options=DENY"
      - "traefik.http.routers.admin.middlewares=admin-headers"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

networks:
  app-network:
    driver: bridge
